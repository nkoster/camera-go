<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Camera</title>
</head>
<body>
<button onclick="start()">Start</button>
<button onclick="stop()">Stop</button><div id="div"></div>
<video id="video" autoplay></video>
<img id="receive" alt=""/>
<script>

var display = { width: 502, height: 376, quality: 0.3, fps: 16 }
var interval = 1000 / display.fps
var proto = location.protocol === 'http:' ? 'ws' : 'wss'
var socket = new WebSocket(proto + '://' + location.host + '/ws')
var playing = false
var image = document.getElementById('receive')
image.width = display.width
image.height = display.height
var video = document.getElementById('video')
video.width = display.width
video.height = display.height

var start = function () {
  if (!playing) {
    navigator.mediaDevices.getUserMedia({ video: true })
    .then(function(stream) {
      video.setAttribute('autoplay', '')
      video.setAttribute('muted', '')
      video.setAttribute('playsinline', '')
      video.srcObject = stream
      playing = true
    })
    .catch(err => {
      console.log(err)
    })
  }
}

socket.onmessage = function(msg) {
  var blob = new Blob([msg.data], {type: 'image/jpeg'})
  image.src = URL.createObjectURL(blob)
}
  
var stop = function () {
  video.srcObject &&
  video.srcObject.getTracks().forEach(function(track) {
    track.stop()
  })
  playing = false
}

var canvas = document.createElement('canvas')
canvas.width = display.width
canvas.height = display.height

var streamer = setInterval(function () {
  if (playing) {
    canvas.getContext('2d').drawImage(video, 0, 0, display.width, display.height)
    canvas.toBlob(function(blob){
      socket.send(blob)
    }, 'image/jpeg', display.quality)
 }
}, interval)

</script>
</body>
</html>
