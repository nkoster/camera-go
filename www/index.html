<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Camera</title>
</head>
<body>
<button onclick="start()">Start</button>
<button onclick="stop()">Stop</button><div id="div"></div>
<video id="video" width="640" height="480" autoplay></video>
<img id="receive" width="640" height="480"/>
<script>

var proto = location.protocol === 'http:' ? 'ws' : 'wss'
var socket = new WebSocket(proto + '://' + location.host + '/ws')
var playing = false
var image = document.getElementById('receive')

var start = function () {
  if (!playing) {
    navigator.mediaDevices.getUserMedia({ video: true })
    .then(function(stream) {
      video.setAttribute('autoplay', '')
      video.setAttribute('muted', '')
      video.setAttribute('playsinline', '')
      video.srcObject = stream
      playing = true
    })
    .catch(err => {
      console.log(err)
    })
  }
  socket.onmessage = function(msg) {
    var blob = new Blob([msg.data], {type: 'image/jpeg'})
    image.src = URL.createObjectURL(blob)
  }

}

var stop = function () {
  clearInterval(streamer)
  video.srcObject &&
  video.srcObject.getTracks().forEach(function(track) {
    track.stop()
  })
  playing = false
  socket.onmessage = () => {}
}

var canvas = document.createElement('canvas')
canvas.width = 640
canvas.height = 480

var streamer = setInterval(function () {
  if (playing) {
    canvas.getContext('2d').drawImage(video, 0, 0, 640, 480)
    canvas.toBlob(function(blob){
      socket.send(blob)
    }, 'image/jpeg', 0.5)
 }
}, 100)

</script>
</body>
</html>
