<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Camera</title>
</head>
<body>
<button onclick="start()">Start</button>
<button onclick="stop()">Stop</button><div id="div"></div>
<video id="video" width="640" height="480" autoplay></video>
<canvas id="preview" width="640" height="480"></canvas>
<script>

var proto = location.protocol === 'http:' ? 'ws' : 'wss'
var socket = new WebSocket(proto + '://' + location.host + '/ws')
var playing = false

var start = function () {
  if (!playing) {
    navigator.mediaDevices.getUserMedia({ video: true })
    .then(function(stream) {
      video.setAttribute('autoplay', '')
      video.setAttribute('muted', '')
      video.setAttribute('playsinline', '')
      video.srcObject = stream
      playing = true
    })
    .catch(console.log('Catch!'))
  }
}

var stop = function () {
  video.srcObject &&
  video.srcObject.getTracks().forEach(function(track) {
    track.stop()
  })
  playing = false
}

var canvas = document.createElement('canvas')
canvas.width = 640
canvas.height = 480

var streamer = setInterval(function () {
  if (playing) {
    canvas.getContext('2d').drawImage(video, 0, 0, 640, 480)
    canvas.toBlob(function(data) {
        socket.send(data)
    })
  }
}, 150)

var preview = document.getElementById('preview')

socket.onmessage = function(data) {
    canvas.srcObject = data
    preview.getContext('2d').drawImage(canvas, 0, 0, 640, 480)
    // console.log(data.data)
}

</script>
</body>
</html>
